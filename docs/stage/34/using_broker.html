<!-- HTML header for doxygen 1.8.14-->
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=9" />
  <meta name="generator" content="Doxygen 1.8.13" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RDMnet: Using the Broker API</title>
  <link href="tabs.css" rel="stylesheet" type="text/css" />
  <script type="text/javascript" src="jquery.js"></script>
  <script type="text/javascript" src="dynsections.js"></script>
  <link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
  <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
  <link href="stylesheet.css" rel="stylesheet" type="text/css" />
  <!--BEGIN CUSTOM SCRIPTS-->
  <script type="text/javascript">
    $(function () {
      $.get('/RDMnet/docs/versions.txt', function (data) {
        if (data) {
          var lines = data.split('\n');
          if (lines.length > 0) {
            var version_select = $("#version_select").empty();
            lines.forEach(function (line) {
              line = line.trim();
              if (!line) {
                return;
              }
              line = line.split(':');
              var option_name = line[0].replace(/^v/, '');
              if (line.length > 1) {
                option_name += ' (' + line[1] + ')';
              }
              var option_val = '/RDMnet/docs/' + line[0];
              var option = $('<option></option>').attr("value", option_val)
                .text(option_name);
              if (window.location.pathname.match('docs/' + line[0])) {
                option = option.attr("selected", "selected");
              }
              version_select.append(option);
            });
          }
        }
      }, 'text');
    });
  </script>
  <script type="text/javascript">
    $(function () { selectAllC() });
  </script>
  <script type="text/javascript">
    function selectAllC() {
      // Enable all C-language blocks
      var tabcontent = document.getElementsByClassName("tabcontent");
      for (i = 0; i < tabcontent.length; i++) {
        if (tabcontent[i].id.endsWith("_c")) {
          tabcontent[i].style.display = "block";
        } else {
          tabcontent[i].style.display = "none"
        }
      }
      // Enable all C-language buttons
      var tablinks = document.getElementsByClassName("tablinks");
      for (i = 0; i < tablinks.length; i++) {
        if (tablinks[i].id.endsWith("_c")) {
          if (!tablinks[i].className.includes("active")) {
            tablinks[i].className = tablinks[i].className += " active";
          }
        } else {
          tablinks[i].className = tablinks[i].className.replace(" active", "");
        }
      }
    }
    function selectAllCpp() {
      // Enable all C++-language blocks
      var tabcontent = document.getElementsByClassName("tabcontent");
      for (i = 0; i < tabcontent.length; i++) {
        if (tabcontent[i].id.endsWith("_cpp")) {
          tabcontent[i].style.display = "block";
        } else {
          tabcontent[i].style.display = "none"
        }
      }
      // Enable all C++-language buttons
      var tablinks = document.getElementsByClassName("tablinks");
      for (i = 0; i < tablinks.length; i++) {
        if (tablinks[i].id.endsWith("_cpp")) {
          if (!tablinks[i].className.includes("active")) {
            tablinks[i].className = tablinks[i].className += " active";
          }
        } else {
          tablinks[i].className = tablinks[i].className.replace(" active", "");
        }
      }
    }
    function selectLanguage(evt, block_id, language) {
      // Get all elements with class="tabcontent" and hide them
      var tabcontent = document.getElementsByClassName("tabcontent");
      for (i = 0; i < tabcontent.length; i++) {
        if (tabcontent[i].id.startsWith("div_" + block_id)) {
          tabcontent[i].style.display = "none";
        }
      }
      // Get all elements with class="tablinks" and remove the class "active"
      var tablinks = document.getElementsByClassName("tablinks");
      for (i = 0; i < tablinks.length; i++) {
        if (tablinks[i].id.startsWith("button_" + block_id)) {
          tablinks[i].className = tablinks[i].className.replace(" active", "");
        }
      }
      // Show the current tab, and add an "active" class to the button that opened the tab
      document.getElementById("div_" + block_id + "_" + language).style.display = "block";
      if (!evt.currentTarget.className.includes("active")) {
        evt.currentTarget.className += " active";
      }
    }
  </script>
  <!--END CUSTOM SCRIPT-->
</head>
<body>
  <div id="top">
    <!-- do not remove this div, it is closed by doxygen! -->
    <div id="titlearea">
      <table cellspacing="0" cellpadding="0" style="width: 100%">
        <tbody>
          <tr style="height: 56px;">
            <td id="projectalign" style="padding-left: 0.5em;">
              <div id="projectname">RDMnet
                &#160;<span id="projectnumber">Staging for pull request 34</span>
              </div>
              <div id="projectbrief">Implementation of ANSI E1.33 (RDMnet)</div>
            </td>
            <!--BEGIN CUSTOM INSERTED SECTION-->
            <td style="text-align: right; padding-right: 0.5em">
              <div id="otherversions">
                View other versions:
                <select id="version_select" onchange="location = this.value">
                </select>
              </div>
            </td>
            <!--END CUSTOM INSERTED SECTION-->
          </tr>
        </tbody>
      </table>
    </div>
    <!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('using_broker.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Using the Broker API </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The RDMnet broker API exposes a C++11 interface for creating instances of RDMnet broker functionality.</p>
<p><b>NOTE:</b> Typically, RDMnet broker functionality should have its own dedicated service, and not be included directly in applications. This API is useful for building an RDMnet broker service, or for applications where background services are not available, such as mobile platforms.</p>
<h2>Initialization</h2>
<p>The RDMnet library must be globally initialized before using the RDMnet broker API. See <a class="el" href="global_init_and_destroy.html">Global Initialization and Destruction</a>.</p>
<p>To create a broker instance, instantiate an <a class="el" href="classrdmnet_1_1_broker.html" title="Defines an instance of RDMnet broker functionality. ">rdmnet::Broker</a> and call its Startup() function. A broker can operate on a single RDMnet scope at a time; the initial scope, and other configuration parameters the broker uses at runtime, are provided via the <a class="el" href="structrdmnet_1_1_broker_settings.html" title="A group of settings for broker operation. ">rdmnet::BrokerSettings</a> struct.</p>
<p>The RDMnet broker API is an asynchronous, callback-oriented API. Part of the initial configuration for a broker instance is an abstract interface for the library to use as callbacks. Callbacks are dispatched from a background thread.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="broker_8h.html">rdmnet/broker.h</a>&quot;</span></div><div class="line"></div><div class="line"><span class="comment">// Each broker is a component that must have a Component ID (CID), which is simply a UUID.</span></div><div class="line"><span class="comment">// Software should generate and save a CID so that the same one is used on each run of the software.</span></div><div class="line"><a class="codeRef" doxygen="/home/vsts/work/1/s/external/EtcPal/docs/etcpal.tag:https://etclabs.github.io/EtcPal/docs/head/" href="https://etclabs.github.io/EtcPal/docs/head/classetcpal_1_1_uuid.html">etcpal::Uuid</a> my_cid = <a class="codeRef" doxygen="/home/vsts/work/1/s/external/EtcPal/docs/etcpal.tag:https://etclabs.github.io/EtcPal/docs/head/" href="https://etclabs.github.io/EtcPal/docs/head/classetcpal_1_1_uuid.html#ae1ccf480526751a937afb32a2db7346a">etcpal::Uuid::OsPreferred</a>();</div><div class="line"></div><div class="line"><span class="comment">// Contains the configuration settings that the broker needs to operate. Some of these are set to</span></div><div class="line"><span class="comment">// default values and can be changed if necessary. Must pass your ESTA manufacturer ID. If you have</span></div><div class="line"><span class="comment">// not yet requested an ESTA manufacturer ID, the range 0x7ff0 to 0x7fff can be used for</span></div><div class="line"><span class="comment">// prototyping.</span></div><div class="line"><a class="code" href="structrdmnet_1_1_broker_settings.html">rdmnet::BrokerSettings</a> settings(my_cid, MY_ESTA_MANUFACTURER_ID_VAL);</div><div class="line"></div><div class="line"><a class="code" href="classrdmnet_1_1_broker.html">rdmnet::Broker</a> broker;</div><div class="line"><a class="codeRef" doxygen="/home/vsts/work/1/s/external/EtcPal/docs/etcpal.tag:https://etclabs.github.io/EtcPal/docs/head/" href="https://etclabs.github.io/EtcPal/docs/head/classetcpal_1_1_error.html">etcpal::Error</a> result = broker.<a class="code" href="classrdmnet_1_1_broker.html#a9a1b7c07d9d066962de3435eed304b05">Startup</a>(settings);</div><div class="line"><span class="keywordflow">if</span> (result)</div><div class="line">{</div><div class="line">  <span class="comment">// Broker is now running</span></div><div class="line">}</div><div class="line"><span class="keywordflow">else</span></div><div class="line">{</div><div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;Error starting broker: &quot;</span> &lt;&lt; result.<a class="codeRef" doxygen="/home/vsts/work/1/s/external/EtcPal/docs/etcpal.tag:https://etclabs.github.io/EtcPal/docs/head/" href="https://etclabs.github.io/EtcPal/docs/head/classetcpal_1_1_error.html#a19c380b03cea21d7ac7325136a131ff0">ToString</a>() &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;</div><div class="line">}</div></div><!-- fragment --><p>Once running, the broker will spawn a number of worker threads and operate independently with no further action needed. The full breakdown of threads used is described in the <a class="el" href="classrdmnet_1_1_broker.html" title="Defines an instance of RDMnet broker functionality. ">rdmnet::Broker</a> class documentation.</p>
<h2>Deinitialization</h2>
<p>The broker should be shut down gracefully before program termination using the Shutdown() function. This function will send graceful disconnect messages to all connected clients, close all network sockets and connections, deallocate resources and join all threads.</p>
<div class="fragment"><div class="line">broker.<a class="code" href="classrdmnet_1_1_broker.html#a4e19a613a75c27cf09fd60446433ca5b">Shutdown</a>();</div><div class="line"></div><div class="line"><span class="comment">// At this point, the broker instance is in a non-running state. It can be started again with the</span></div><div class="line"><span class="comment">// Startup() function.</span></div></div><!-- fragment --><h2>Changing Settings at Runtime</h2>
<h3>Scope</h3>
<p>The broker's scope can be changed at runtime using the ChangeScope() function.</p>
<div class="fragment"><div class="line"><a class="codeRef" doxygen="/home/vsts/work/1/s/external/EtcPal/docs/etcpal.tag:https://etclabs.github.io/EtcPal/docs/head/" href="https://etclabs.github.io/EtcPal/docs/head/classetcpal_1_1_error.html">etcpal::Error</a> result = broker.<a class="code" href="classrdmnet_1_1_broker.html#ab54f8c7ed4dfd4a314a824b89e0f5a5b">ChangeScope</a>(<span class="stringliteral">&quot;new scope string&quot;</span>, <a class="code" href="group__rdmnet__api__common.html#gga3eb1adaf6e830a807d1dcfbc64197222a25de5a2953a7a4ae379975bb300d8165">kRdmnetDisconnectUserReconfigure</a>);</div><div class="line"><span class="keywordflow">if</span> (result)</div><div class="line">{</div><div class="line">  <span class="comment">// Broker is now using the new scope.</span></div><div class="line">}</div><div class="line"><span class="keywordflow">else</span></div><div class="line">{</div><div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;Error changing broker&#39;s scope: &quot;</span> &lt;&lt; result.<a class="codeRef" doxygen="/home/vsts/work/1/s/external/EtcPal/docs/etcpal.tag:https://etclabs.github.io/EtcPal/docs/head/" href="https://etclabs.github.io/EtcPal/docs/head/classetcpal_1_1_error.html#a19c380b03cea21d7ac7325136a131ff0">ToString</a>() &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;</div><div class="line">}</div></div><!-- fragment --><p>When the scope changes, the broker will disconnect all currently connected clients using the disconnect reason code given in the disconnect_reason parameter. It will then restart broker services and re-register for discovery using the new scope.</p>
<h2>Logging</h2>
<p>Brokers can log messages using the <a class="elRef" doxygen="/home/vsts/work/1/s/external/EtcPal/docs/etcpal.tag:https://etclabs.github.io/EtcPal/docs/head/" href="https://etclabs.github.io/EtcPal/docs/head/classetcpal_1_1_logger.html">etcpal::Logger</a> class. To capture logs from the broker, set up an <a class="elRef" doxygen="/home/vsts/work/1/s/external/EtcPal/docs/etcpal.tag:https://etclabs.github.io/EtcPal/docs/head/" href="https://etclabs.github.io/EtcPal/docs/head/classetcpal_1_1_logger.html">etcpal::Logger</a> instance per its documentation, and pass it to the broker instance on startup:</p>
<div class="fragment"><div class="line"><a class="codeRef" doxygen="/home/vsts/work/1/s/external/EtcPal/docs/etcpal.tag:https://etclabs.github.io/EtcPal/docs/head/" href="https://etclabs.github.io/EtcPal/docs/head/classetcpal_1_1_logger.html">etcpal::Logger</a> logger;</div><div class="line">logger.<a class="codeRef" doxygen="/home/vsts/work/1/s/external/EtcPal/docs/etcpal.tag:https://etclabs.github.io/EtcPal/docs/head/" href="https://etclabs.github.io/EtcPal/docs/head/classetcpal_1_1_logger.html#adf3a549fed7e9cf73833af591af43071">SetLogMask</a>(<a class="codeRef" doxygen="/home/vsts/work/1/s/external/EtcPal/docs/etcpal.tag:https://etclabs.github.io/EtcPal/docs/head/" href="https://etclabs.github.io/EtcPal/docs/head/group__etcpal__log.html#gaecd624f2fc15671bb3e4c01ede198a08">ETCPAL_LOG_UPTO</a>(<a class="codeRef" doxygen="/home/vsts/work/1/s/external/EtcPal/docs/etcpal.tag:https://etclabs.github.io/EtcPal/docs/head/" href="https://etclabs.github.io/EtcPal/docs/head/group__etcpal__log.html#ga9f05a0ad034946dfd20477e11d2923a7">ETCPAL_LOG_INFO</a>)).<a class="codeRef" doxygen="/home/vsts/work/1/s/external/EtcPal/docs/etcpal.tag:https://etclabs.github.io/EtcPal/docs/head/" href="https://etclabs.github.io/EtcPal/docs/head/classetcpal_1_1_logger.html#a84e487b1e20733405bd8b870e59f670c">Startup</a>(my_log_message_handler);</div><div class="line"></div><div class="line">broker.<a class="code" href="classrdmnet_1_1_broker.html#a9a1b7c07d9d066962de3435eed304b05">Startup</a>(settings, &amp;logger);</div></div><!-- fragment --><p>The broker logs messages at appropriate syslog-style severity levels; for example, if you set the logger's log mask to <a class="elRef" doxygen="/home/vsts/work/1/s/external/EtcPal/docs/etcpal.tag:https://etclabs.github.io/EtcPal/docs/head/" href="https://etclabs.github.io/EtcPal/docs/head/group__etcpal__log.html#gaecd624f2fc15671bb3e4c01ede198a08">ETCPAL_LOG_UPTO(ETCPAL_LOG_DEBUG)</a>, the broker will log <em>lots</em> of messages (including a message logged for every message the broker routes). If you set it to <a class="elRef" doxygen="/home/vsts/work/1/s/external/EtcPal/docs/etcpal.tag:https://etclabs.github.io/EtcPal/docs/head/" href="https://etclabs.github.io/EtcPal/docs/head/group__etcpal__log.html#gaecd624f2fc15671bb3e4c01ede198a08">ETCPAL_LOG_UPTO(ETCPAL_LOG_ERR)</a>, the logging will be much more sparse and only represent error conditions.</p>
<h2>Broker Notifications</h2>
<p>The broker can pass notifications of certain events back to the application for handling. Currently, these notifications are all informational; broker instances operate the same way regardless of how they are handled.</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>MyBrokerNotifyHandler : <span class="keyword">public</span> <a class="code" href="classrdmnet_1_1_broker_notify_handler.html">rdmnet::BrokerNotifyHandler</a></div><div class="line">{</div><div class="line">  <span class="comment">// Implement the BrokerNotifyHandler functions...</span></div><div class="line">}</div><div class="line"></div><div class="line">MyBrokerNotifyHandler notify_handler;</div><div class="line">broker.<a class="code" href="classrdmnet_1_1_broker.html#a9a1b7c07d9d066962de3435eed304b05">Startup</a>(settings, &amp;logger, &amp;notify_handler);</div></div><!-- fragment --><h3>Scope Changed</h3>
<p>If BrokerSettings::allow_rdm_scope_change was set to true at the initialization of a broker instance, the broker will accept RDM commands which change its scope. When this happens, it will also deliver a scope changed notification to the notification handler.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> MyBrokerNotifyHandler::HandleScopeChanged(<span class="keyword">const</span> std::string&amp; new_scope)</div><div class="line">{</div><div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;Broker&#39;s scope changed to &#39;&quot;</span> &lt;&lt; new_scope &lt;&lt; <span class="stringliteral">&quot;&#39;\n&quot;</span>;</div><div class="line">}</div></div><!-- fragment --> </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="getting_started.html">Getting Started</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
